// src/pages/AddRabbitForm.jsx
import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";

const API_BASE = process.env.REACT_APP_API_BASE || "http://localhost:3000";

export default function AddRabbitForm() {
  const [name, setName] = useState("");
  const [breed, setBreed] = useState("");
  const [age, setAge] = useState("");
  const [gender, setGender] = useState("male");
  const [price, setPrice] = useState("");
  const [stock, setStock] = useState(0);
  const [description, setDescription] = useState("");

  // ‚úÖ ‡πÉ‡∏´‡∏°‡πà: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)
  const [weight, setWeight] = useState("");

  // ‚úÖ ‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå
  const [isParent, setIsParent] = useState(false);
  const [parentRole, setParentRole] = useState(""); // 'sire' | 'dam'
  const [availableDate, setAvailableDate] = useState("");

  const [file, setFile] = useState(null);
  const [preview, setPreview] = useState(null);
  const [submitting, setSubmitting] = useState(false);

  const navigate = useNavigate();

  useEffect(() => () => { if (preview) URL.revokeObjectURL(preview); }, [preview]);

  const handleImageUpload = (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const okTypes = ["image/jpeg", "image/png", "image/webp", "image/jpg"];
    if (!okTypes.includes(f.type)) { alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå jpg, png, webp"); e.target.value = ""; return; }
    if (f.size > 5 * 1024 * 1024) { alert("‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB"); e.target.value = ""; return; }
    setFile(f);
    setPreview(URL.createObjectURL(f));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!name?.trim()) { alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢"); return; }
    if (price === "" || Number(price) < 0) { alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (>= 0)"); return; }
    if (stock === "" || Number(stock) < 0 || !Number.isInteger(Number(stock))) {
      alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö"); return;
    }
    if (isParent && !parentRole) { alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå"); return; }

    try {
      setSubmitting(true);

      let image_url = "";
      if (file) {
        const fd = new FormData();
        fd.append("profileImage", file);
        const up = await fetch(`${API_BASE}/api/upload`, { method: "POST", body: fd });
        if (!up.ok) throw new Error(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${await up.text()}`);
        const r = await up.json();
        image_url = r.url;
      }

      const payload = {
        name: name.trim(),
        breed: breed?.trim() || null,
        age: age ? Number(age) : null,
        gender,
        price: Number(price),
        stock: Number(stock),
        description: description?.trim() || null,
        image_url,
        status: "available",

        // ‚úÖ ‡∏™‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ (null ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å)
        weight: weight === "" ? null : Number(weight),

        // ‚úÖ ‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå
        is_parent: Boolean(isParent),
        parent_role: isParent ? parentRole : null,
        available_date: availableDate || null,
      };

      const save = await fetch(`${API_BASE}/api/admin/rabbits`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!save.ok) throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${await save.text()}`);

      alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      navigate("/manage-rabbits");
    } catch (err) {
      console.error(err);
      alert(err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="flex justify-center items-center py-10">
      <div className="bg-white shadow-lg rounded-xl p-8 w-full max-w-lg">
        <h1 className="text-2xl font-bold text-center mb-6">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢ üêá</h1>

        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Upload */}
          <div className="flex justify-center">
            <label htmlFor="fileUpload" className="cursor-pointer">
              <input type="file" accept="image/*" onChange={handleImageUpload} hidden id="fileUpload" />
              <div className="w-40 h-40 border-2 border-dashed rounded-lg flex items-center justify-center overflow-hidden hover:border-green-500 transition">
                {preview ? <img src={preview} alt="Rabbit" className="w-full h-full object-cover" /> : <span className="text-4xl text-gray-400">+</span>}
              </div>
            </label>
          </div>

          {/* ‡∏ä‡∏∑‡πà‡∏≠/‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå/‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏û‡∏®/‡∏£‡∏≤‡∏Ñ‡∏≤ */}
          <div>
            <label className="block font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢</label>
            <input value={name} onChange={(e) => setName(e.target.value)} required className="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>

          <div>
            <label className="block font-medium">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢</label>
            <input value={breed} onChange={(e) => setBreed(e.target.value)} className="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>

          <div>
            <label className="block font-medium">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
            <input value={age} onChange={(e) => setAge(e.target.value)} type="number" min="0" className="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>

          <div>
            <label className="block font-medium mb-1">‡πÄ‡∏û‡∏®</label>
            <div className="flex gap-6">
              <label className="flex items-center gap-2">
                <input type="radio" name="gender" value="male" checked={gender === "male"} onChange={(e) => setGender(e.target.value)} /> ‚ôÇ ‡πÄ‡∏û‡∏®‡∏ú‡∏π‡πâ
              </label>
              <label className="flex items-center gap-2">
                <input type="radio" name="gender" value="female" checked={gender === "female"} onChange={(e) => setGender(e.target.value)} /> ‚ôÄ ‡πÄ‡∏û‡∏®‡πÄ‡∏°‡∏µ‡∏¢
              </label>
            </div>
          </div>

          <div>
            <label className="block font-medium">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
            <input value={price} onChange={(e) => setPrice(e.target.value)} type="number" min="0" required className="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>

          {/* ‡∏™‡∏ï‡πä‡∏≠‡∏Å */}
          <div>
            <label className="block font-medium">‡∏™‡∏ï‡πä‡∏≠‡∏Å (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</label>
            <div className="flex gap-2">
              <input
                value={stock}
                onChange={(e) => {
                  const v = e.target.value;
                  if (v === "") return setStock("");
                  const n = Number(v);
                  if (Number.isInteger(n) && n >= 0) setStock(n);
                }}
                type="number"
                min="0"
                className="mt-1 w-full border rounded-lg px-3 py-2"
              />
              <button type="button" className="mt-1 px-3 rounded border hover:bg-gray-50" onClick={() => setStock((s) => Math.max(0, Number(s || 0) - 1))}>‚àí1</button>
              <button type="button" className="mt-1 px-3 rounded border hover:bg-gray-50" onClick={() => setStock((s) => Number(s || 0) + 1)}>+1</button>
            </div>
          </div>

          {/* ‚úÖ ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å */}
          <div>
            <label className="block font-medium">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
            <input
              value={weight}
              onChange={(e) => setWeight(e.target.value)}
              type="number"
              step="0.01"
              min="0"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 2.35"
              className="mt-1 w-full border rounded-lg px-3 py-2"
            />
          </div>

          {/* ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå */}
          <div className="border-t pt-4">
            <label className="flex items-center gap-2 font-medium">
              <input type="checkbox" checked={isParent} onChange={(e) => setIsParent(e.target.checked)} />
              ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏û‡πà‡∏≠/‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‚Äù
            </label>

            {isParent && (
              <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                  <select value={parentRole} onChange={(e) => setParentRole(e.target.value)} className="w-full border rounded-lg px-3 py-2" required={isParent}>
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</option>
                    <option value="sire">‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (sire)</option>
                    <option value="dam">‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (dam)</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°/‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                  <input type="date" value={availableDate} onChange={(e) => setAvailableDate(e.target.value)} className="w-full border rounded-lg px-3 py-2" />
                </div>
              </div>
            )}
          </div>

          {/* ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ */}
          <div>
            <label className="block font-medium">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
            <textarea value={description} onChange={(e) => setDescription(e.target.value)} rows={3} placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏ô‡∏¥‡∏™‡∏±‡∏¢/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏Ø‡∏•‡∏Ø" className="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>

          {/* Submit */}
          <button type="submit" disabled={submitting} className={`w-full py-3 rounded-lg text-white font-bold transition ${submitting ? "bg-green-300 cursor-not-allowed" : "bg-green-500 hover:bg-green-600"}`}>
            {submitting ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..." : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}
          </button>
        </form>
      </div>
    </div>
  );
}
