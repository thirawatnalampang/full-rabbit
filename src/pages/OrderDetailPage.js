// src/pages/OrderDetailPage.jsx
import { useEffect, useState } from "react";
import { useParams, Link } from "react-router-dom";

const API_BASE = process.env.REACT_APP_API_BASE || "http://localhost:3000";
const thb = (n) =>
  new Intl.NumberFormat("th-TH", { style: "currency", currency: "THB" }).format(Number(n || 0));

/* ---------- ‡πÅ‡∏õ‡∏•‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢ ---------- */
const STATUS_TH = {
  pending: "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£",
  ready_to_ship: "‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á",
  shipped: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß",
  done: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
  cancelled: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
};
const PAYMENT_TH = {
  unpaid: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞",
  submitted: "‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß",
  paid: "‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß",
  rejected: "‡∏™‡∏•‡∏¥‡∏õ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò",
};
const METHOD_TH = { cod: "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á", bank_transfer: "‡πÇ‡∏≠‡∏ô" };
const ITEM_TYPE_TH = { rabbit: "‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢", "pet-food": "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå", equipment: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" };
const SHIPPING_TH = { standard: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏õ‡∏Å‡∏ï‡∏¥", express: "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô", pickup: "‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô" };

/* ---------- Tracking helpers ---------- */
const trackingUrl = (carrier, code) => {
  if (!code) return null;
  const c = String(carrier || "").toLowerCase();
  const q = encodeURIComponent(code);
  if (c.includes("kerry")) return `https://th.kerryexpress.com/th/track/?track=${q}`;
  if (c.includes("thai") || c.includes("ems")) return `https://track.thailandpost.co.th/?trackNumber=${q}`;
  if (c.includes("j&t") || c.includes("jnt")) return `https://www.jtexpress.co.th/index/query/gzquery.html?billcode=${q}`;
  if (c.includes("flash")) return `https://www.flashexpress.com/fle/tracking?se=${q}`;
  return `https://www.google.com/search?q=${encodeURIComponent(`${carrier || ""} ${code}`)}`;
};

function TrackingBadge({ carrier, code, updatedAt }) {
  if (!code) return null;
  const url = trackingUrl(carrier, code);
  return (
    <div className="flex flex-col items-start gap-0.5 text-xs mt-2">
      <a
        href={url}
        target="_blank"
        rel="noreferrer"
        className="px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200"
        title="‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏±‡∏™‡∏î‡∏∏"
      >
        üì¶ {carrier ? `${carrier} ‚Ä¢ ` : ""}‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: <span className="font-semibold">{code}</span>
      </a>
      {updatedAt ? (
        <span className="text-neutral-400">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï {new Date(updatedAt).toLocaleString("th-TH")}</span>
      ) : null}
    </div>
  );
}

/* ---------- ‡∏ä‡πà‡∏ß‡∏¢‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ---------- */
function formatAddress(a) {
  if (!a) return "";
  if (typeof a === "string") return a;
  const line1 = [a.address].filter(Boolean).join(" ");
  const line2 = [a.district, a.province, a.zipcode].filter(Boolean).join(" ");
  return [line1, line2].filter(Boolean).join("\n");
}

export default function OrderDetailPage() {
  const { id } = useParams();
  const [data, setData] = useState(null);
  const [err, setErr] = useState("");

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch(`${API_BASE}/api/orders/${id}`);
        if (!res.ok) throw new Error("not ok");
        const json = await res.json();
        setData(json);
      } catch {
        setErr("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
      }
    })();
  }, [id]);

  if (err) return <div className="max-w-4xl mx-auto p-6">{err}</div>;
  if (!data) return <div className="max-w-4xl mx-auto p-6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>;

  const { order, items } = data;

  // address ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô string ‚Üí ‡∏•‡∏≠‡∏á parse
  let addr = order.shipping_address || {};
  if (typeof addr === "string") {
    try {
      addr = JSON.parse(addr);
    } catch {
      // keep as string
    }
  }

  // ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏
  const trackingCarrier = order.carrier || "";
  const trackingCode = order.tracking_code || order.tracking_number || "";
  const trackingUpdatedAt = order.tracking_updated_at || null;

  return (
    <div className="max-w-4xl mx-auto px-4 md:px-6 py-8">
      {/* breadcrumbs */}
      <div className="text-sm text-neutral-500 mb-2">
        <Link to="/" className="hover:underline">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</Link> <span className="mx-1">/</span>
        <Link to="/my-orders" className="hover:underline">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</Link> <span className="mx-1">/</span>
        ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ #{order.order_id}
      </div>

      <h1 className="text-2xl font-extrabold mb-4">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ #{order.order_id}</h1>

      <div className="grid md:grid-cols-2 gap-4">
        {/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */}
        <div className="bg-white border rounded-2xl p-4">
          <div className="font-semibold mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>

          <div className="text-sm">
            ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:{" "}
            <span className="px-2 py-0.5 bg-neutral-100 rounded">
              {STATUS_TH[order.status] || order.status}
            </span>
          </div>

          <div className="text-sm mt-1">
            ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô: {METHOD_TH[order.payment_method] || order.payment_method} ‚Ä¢{" "}
            <span className="px-2 py-0.5 bg-neutral-100 rounded">
              {PAYMENT_TH[order.payment_status] || order.payment_status}
            </span>
          </div>

          <TrackingBadge carrier={trackingCarrier} code={trackingCode} updatedAt={trackingUpdatedAt} />

          {order.payment_slip_path && (
            <div className="text-sm mt-2">
              ‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô:{" "}
              <a
                href={`${API_BASE}${order.payment_slip_path}`}
                target="_blank"
                rel="noreferrer"
                className="text-blue-600 underline"
              >
                ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π
              </a>
            </div>
          )}

          <div className="text-sm mt-1">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {new Date(order.order_date).toLocaleString("th-TH")}
          </div>
        </div>

        {/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö & ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á */}
        <div className="bg-white border rounded-2xl p-4">
          <div className="font-semibold mb-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö & ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</div>

          {/* ‡∏ä‡∏∑‡πà‡∏≠ + ‡πÄ‡∏ö‡∏≠‡∏£‡πå */}
          <div className="text-sm">
            {order.contact_full_name} ‚Ä¢ {order.contact_phone}
          </div>

          {/* ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡πà‡∏á */}
          <div className="text-sm mt-1">
            ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡πà‡∏á: {SHIPPING_TH[order.shipping_method] || order.shipping_method || "-"}
          </div>

          {/* ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà pickup) */}
          {order.shipping_method !== "pickup" && order.shipping_address ? (
            <div className="mt-2">
              <div className="text-sm font-semibold mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>
              <div className="text-sm whitespace-pre-line">
                {formatAddress(addr)}
              </div>
            </div>
          ) : null}
        </div>
      </div>

      {/* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° */}
      <div className="bg-white border rounded-2xl p-4 mt-4">
        <div className="font-semibold mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>

        <div className="space-y-2">
          {items.map((it) => (
            <div key={it.order_detail_id ?? `${it.item_type}-${it.item_id}`} className="flex items-center justify-between text-sm">
              <div>
                <div className="font-medium">
                  {ITEM_TYPE_TH[it.item_type] || it.item_type} #{it.item_id}
                </div>
                <div className="text-neutral-500">x{it.quantity}</div>
              </div>
              <div className="font-semibold">{thb((it.quantity || 0) * (it.price || 0))}</div>
            </div>
          ))}
        </div>

        <div className="my-3 border-t" />

        <div className="text-sm space-y-1">
          <div className="flex justify-between">
            <span>‡∏¢‡∏≠‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            <span>
              {thb(order.subtotal ?? items.reduce((s, it) => s + Number((it.quantity || 0) * (it.price || 0)), 0))}
            </span>
          </div>
          <div className="flex justify-between">
            <span>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</span>
            <span>{thb(order.shipping_fee || 0)}</span>
          </div>
          {Number(order.discount) > 0 && (
            <div className="flex justify-between">
              <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
              <span>-{thb(order.discount || 0)}</span>
            </div>
          )}
        </div>

        <div className="my-3 border-t" />

        <div className="flex justify-between font-semibold">
          <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
          <span className="text-emerald-600">{thb(order.total_amount)}</span>
        </div>
      </div>
    </div>
  );
}
