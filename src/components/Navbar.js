// src/components/Navbar.jsx
import { Link, useNavigate, useLocation } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { useEffect, useState } from 'react';
import {
  FaHome,
  FaPaw,
  FaShoppingCart,
  FaUserAlt,
  FaPlus,
  FaSearch,
  FaArrowLeft,
  FaListAlt,
  FaTimes,
  FaBookOpen,
  
} from 'react-icons/fa';

export default function Navbar() {
  const { user } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();

  const [searchQuery, setSearchQuery] = useState('');
  const [showMobileSearch, setShowMobileSearch] = useState(false);

  useEffect(() => { setShowMobileSearch(false); }, [location.pathname]);

  const handleSearch = () => {
  const q = searchQuery.trim();
  if (!q) {
    navigate('/search');                  // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô ‚Üí ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ search ‡πÄ‡∏õ‡∏•‡πà‡∏≤
  } else {
    navigate(`/search?q=${encodeURIComponent(q)}`);  // ‚úÖ ‡πÉ‡∏ä‡πâ q ‡πÅ‡∏ó‡∏ô query
  }
  setShowMobileSearch(false);             // ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
};
  return (
    <>
      {/* ===== Desktop / Tablet ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */}
      <nav
        className="hidden md:flex bg-black text-white p-4 justify-between items-center shadow-md"
        key={user?.user_id || 'guest'}
      >
      {/* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Home) */}
{location.pathname !== "/" && (
  <button
    onClick={() => navigate(-1)}
    className="text-white mr-4 hover:text-teal-300 transition-colors duration-300"
    title="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö"
  >
    <FaArrowLeft size={26} />
  </button>
)}

        {/* ‡πÇ‡∏•‡πÇ‡∏Å‡πâ */}
        <span className="text-2xl font-extrabold tracking-wide text-white">üêæ PetShop</span>

        {/* ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */}
        <div className="flex items-center bg-white rounded-full px-3 py-1 mx-4 flex-grow max-w-lg">
          <input
            type="text"
            placeholder="Search products..."
            className="focus:outline-none text-black bg-transparent w-full"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
          />
          <button onClick={handleSearch}>
            <FaSearch className="text-black ml-2" />
          </button>
        </div>

        {/* ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ß‡∏≤ */}
        <div className="flex items-center space-x-6 text-lg font-medium">
          <Link to="/" title="‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å" className="hover:text-teal-300 transition-colors duration-300">
            <FaHome size={26} />
          </Link>
          <Link to="/pets" title="‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á" className="hover:text-teal-300 transition-colors duration-300">
            <FaPaw size={26} />
          </Link>
          <Link to="/cart" title="‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" className="hover:text-teal-300 transition-colors duration-300">
            <FaShoppingCart size={26} />
          </Link>
{user && (
  <Link to="/my-loans" title="‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" className="hover:text-teal-300 transition-colors duration-300">
    <FaBookOpen size={26} />
  </Link>
)}

          {user && (
            <Link to="/my-orders" title="‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" className="hover:text-teal-300 transition-colors duration-300">
              <FaListAlt size={26} />
            </Link>
          )}

          {user?.role === 'admin' && (
            <Link
              to="/seller-dashboard"
              title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
              className="bg-green-500 hover:bg-green-600 transition-colors duration-300 rounded-full p-2"
            >
              <FaPlus size={20} />
            </Link>
          )}

          {user ? (
            <Link to="/profile" title="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå" className="hover:text-teal-300 transition-colors duration-300">
              {user.profileImage && user.profileImage.trim() !== '' ? (
                <img
                  src={`${user.profileImage}?t=${Date.now()}`}
                  alt="Profile"
                  className="w-12 h-12 rounded-full object-cover"
                  referrerPolicy="no-referrer"
                />
              ) : (
                <FaUserAlt size={28} className="w-8 h-8 p-1 rounded-full bg-white text-black" />
              )}
            </Link>
          ) : (
            <Link to="/login" title="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" className="hover:text-teal-300 transition-colors duration-300">
              ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </Link>
          )}
        </div>
      </nav>

      {/* ===== Mobile / Tablet ‡πÄ‡∏•‡πá‡∏Å ===== */}
      <nav className="md:hidden sticky top-0 z-50 bg-black text-white shadow-md" key={(user?.user_id || 'guest') + '-m'}>
        {/* ‡πÅ‡∏ñ‡∏ö‡∏ö‡∏ô‡∏ö‡∏≤‡∏á */}
        <div className="h-14 px-3 flex items-center justify-between">
          <button
            onClick={() => navigate(-1)}
            className="p-2 rounded-lg hover:bg-white/10 active:scale-95 transition"
            title="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö"
            aria-label="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö"
          >
            <FaArrowLeft size={20} />
          </button>

          <span className="text-xl font-extrabold tracking-wide select-none">üêæ PetShop</span>

          <button
            className="p-2 rounded-lg hover:bg-white/10 active:scale-95 transition"
            onClick={() => setShowMobileSearch((v) => !v)}
            aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
            title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
          >
            {showMobileSearch ? <FaTimes size={20} /> : <FaSearch size={20} />}
          </button>
        </div>

        {/* ‡πÅ‡∏ú‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏™‡πÑ‡∏•‡∏î‡πå‡∏•‡∏á) */}
        <div
          className={`overflow-hidden transition-[max-height] duration-300 ease-out ${
            showMobileSearch ? 'max-h-24' : 'max-h-0'
          }`}
        >
          <div className="px-3 pb-3">
            <div className="flex items-center bg-white rounded-xl px-3 py-2">
              <input
                type="text"
                placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
                className="focus:outline-none text-black bg-transparent w-full placeholder-gray-500"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
              />
              <button
                onClick={handleSearch}
                className="ml-2 px-3 py-1.5 rounded-lg bg-black text-white active:scale-95 transition"
                aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
              >
                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
            </div>
          </div>
        </div>
      </nav>

{/* Bottom Tab Bar (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å) */}
<nav
  className="md:hidden fixed bottom-0 inset-x-0 z-[60] bg-black/95 backdrop-blur
             pb-[calc(env(safe-area-inset-bottom,0px))]
             border-t border-white/10"
  role="navigation"
  aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á"
>
  <div className="flex items-stretch justify-around">
    <TabLink to="/"        label="‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å"     icon={<FaHome />}          active={location.pathname === '/'} />
    <TabLink to="/pets"    label="‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á" icon={<FaPaw />}           active={location.pathname.startsWith('/pets')} />
    <TabLink to="/cart"    label="‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤"       icon={<FaShoppingCart />}  active={location.pathname.startsWith('/cart')} />

    {user && (
      <TabLink to="/my-loans" label="‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°" icon={<FaBookOpen />} active={location.pathname.startsWith('/my-loans')} />
    )}

    {user ? (
      <TabLink to="/my-orders" label="‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" icon={<FaListAlt />} active={location.pathname.startsWith('/my-orders')} />
    ) : (
      <TabLink to="/login"     label="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" icon={<FaUserAlt />} active={location.pathname.startsWith('/login')} />
    )}

    <TabLink
      to={user ? '/profile' : '/login'}
      label="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå"
      icon={<FaUserAlt />}
      active={
        user
          ? location.pathname.startsWith('/profile')
          : location.pathname.startsWith('/login')
      }
    />
  </div>
</nav>


{/* Spacer ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏ó‡∏±‡∏ö Bottom Bar */}
<div className="md:hidden h-[64px]" />

      {/* Admin FAB (‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å) */}
      {user?.role === 'admin' && (
        <Link
          to="/seller-dashboard"
          className="md:hidden fixed right-4 bottom-20 rounded-full bg-green-500 hover:bg-green-600 text-white p-4 shadow-xl active:scale-95 transition"
          title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
          aria-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
        >
          <FaPlus />
        </Link>
      )}

      {/* Spacer ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏ó‡∏±‡∏ö Bottom Bar */}
      <div className="md:hidden h-16" />
    </>
  );
}

function TabLink({ to, icon, label, active }) {
  return (
    <Link
      to={to}
      className={`flex-1 min-w-[64px] flex flex-col items-center justify-center
                  py-2.5 text-[11px] leading-none transition
                  ${active ? 'text-teal-300' : 'text-white/90 hover:text-white'}`}
      title={label}
      aria-label={label}
    >
      <div className={`text-xl ${active ? 'scale-110' : ''}`}>{icon}</div>
      {/* ‡∏ã‡πà‡∏≠‡∏ô label ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏Å‡∏ß‡πâ‡∏≤‡∏á < 360px ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏µ‡∏¢‡∏î */}
      <span className="mt-1 hidden [@media(min-width:360px)]:inline">{label}</span>
    </Link>
  );
}
