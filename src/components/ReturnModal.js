import React, { useState, useEffect } from "react";
import ReturnModal from "../components/ReturnModal"; // ‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏°‡∏î‡∏±‡∏•

export default function MyLoansPage() {
  const [loans, setLoans] = useState([]);
  const [openReturn, setOpenReturn] = useState(false);     // ‚úÖ state ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•
  const [selectedLoanId, setSelectedLoanId] = useState(null); // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö loan ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô

  const refreshLoans = async () => {
    const res = await fetch(`${process.env.REACT_APP_API_BASE || 'http://localhost:3000'}/api/my-loans?buyer_id=...`);
    const data = await res.json();
    setLoans(data || []);
  };

  useEffect(() => { refreshLoans(); }, []);

  const openReturnFor = (loanId) => {     // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
    setSelectedLoanId(loanId);
    setOpenReturn(true);
  };

  return (
    <div>
      {loans.map((loan) => (
        <div key={loan.loan_id} className="border rounded p-3 mb-3">
          <div>‡∏Ñ‡∏≥‡∏¢‡∏∑‡∏° #{loan.loan_id} ‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {loan.status}</div>

          {loan.status === 'on_loan' && (
            <button
              onClick={() => openReturnFor(loan.loan_id)}   // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
              className="mt-3 px-3 py-2 rounded border"
            >
              üì¶ ‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô
            </button>
          )}
        </div>
      ))}

      {/* ‚úÖ ‡∏ß‡∏≤‡∏á‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÑ‡∏ß‡πâ‡∏ô‡∏≠‡∏Å .map (‡∏°‡∏µ‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤) */}
      <ReturnModal
        open={openReturn}
        onClose={() => setOpenReturn(false)}
        loanId={selectedLoanId}
        onDone={() => { setOpenReturn(false); refreshLoans(); }} // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      />
    </div>
  );
}
